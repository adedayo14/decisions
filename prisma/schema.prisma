// Shopify App Starter - Minimal Schema
// Add your app-specific models below

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Required for Shopify session storage
model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

// Shop settings for Decisions
model Shop {
  id                  String   @id @default(cuid())
  shop                String   @unique  // mystore.myshopify.com
  currency            String   @default("GBP")  // Shop's currency code (USD, EUR, GBP, etc.)
  currencySymbol      String   @default("£")    // Currency symbol for display
  assumedShippingCost Float    @default(3.50)  // Default shipping cost per order
  lastOrderCount      Int?     // Last known order count (90 days)
  lastAnalyzedAt      DateTime?  // When we last ran analysis
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// COGS (Cost of Goods Sold) - Product costs
model COGS {
  id        String   @id @default(cuid())
  shop      String
  variantId String   // Shopify variant ID (as string)
  costGbp   Float    // Cost per unit in GBP
  source    String   // "shopify" | "manual" | "csv"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([shop, variantId])
  @@index([shop])
  @@index([shop, source])
}

// Decision run tracking (v2: archive/history)
model DecisionRun {
  id          String   @id @default(cuid())
  shop        String
  generatedAt DateTime @default(now())
  orderCount  Int      // Number of orders analyzed
  windowDays  Int      @default(90) // Analysis window in days
  createdAt   DateTime @default(now())

  @@index([shop, generatedAt])
}

// Decision tracking
model Decision {
  id          String   @id @default(cuid())
  shop        String
  type        String   // "best_seller_loss" | "free_shipping_trap" | "discount_refund_hit"
  status      String   @default("active") // "active" | "done" | "ignored"

  // Decision content
  headline    String   // "£X / month at risk" or "£X / month opportunity"
  actionTitle String   // "Stop pushing Classic Hoodie..."
  reason      String   // One-line explanation with numbers
  impact      Float    // £ value (positive)
  confidence  String   // "high" | "medium" | "low"

  // Supporting data for "See numbers" modal
  dataJson    Json     // { revenue, cogs, discounts, refunds, shipping, netProfit }

  // v2: Link to decision run and stable key for tracking
  runId       String?  // Link to DecisionRun
  decisionKey String   @default("") // Stable key for tracking repeats (e.g., "best_seller_loss:variant_12345")

  // Metadata
  generatedAt DateTime @default(now())
  completedAt DateTime?
  ignoredAt   DateTime?

  @@index([shop, status])
  @@index([shop, generatedAt])
  @@index([shop, type, status])
  @@index([shop, runId])
  @@index([shop, decisionKey])
}

// Cache for aggregated Shopify data (avoid re-fetching constantly)
model DataCache {
  id        String   @id @default(cuid())
  shop      String
  cacheKey  String   // e.g., "orders_last_90_days", "variant_costs"
  dataJson  Json     // Cached data
  expiresAt DateTime // 24-hour expiry
  createdAt DateTime @default(now())

  @@unique([shop, cacheKey])
  @@index([shop])
  @@index([expiresAt]) // For cleanup
}
